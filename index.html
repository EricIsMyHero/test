<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kart Qalereyası</title>
    <style>
        :root {
            --bg: #0f1220;
            --card: #151934;
            --muted: #8a92b2;
            --text: #eaf0ff;
            --ring: #ffffff20;
            --shadow: 0 10px 30px rgba(0,0,0,.35);
        
            /* Nadirlik rəngləri */
            --mundane: #CCCCCC;
            --familiar: #4CAF50;
            --arcane: #7E57C2;
            --mythic: #E53935;
            --legendary: #FBC02D;
            --ethereal: #ff007f;
        }
        
        * { box-sizing: border-box }
        html, body { height: 100% }
        body {
            margin: 0;
            background: radial-gradient(1200px 700px at 20% 0%, #1a1f3f, #0f1220 60%);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, Segoe UI, Roboto;
        }
        
        .wrap { max-width: 1200px; margin: 32px auto; padding: 16px }
        header { display: flex; gap: 16px; justify-content: space-between; align-items: center; margin-bottom: 18px }
        h1 { font-size: 28px; margin: 0; letter-spacing: .2px }
        .hint { color: var(--muted); font-size: 14px }
        
        .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 8px }
        button {
            background: #22284f; color: var(--text);
            border: 1px solid #2f3769; border-radius: 12px;
            padding: 10px 14px; cursor: pointer;
            box-shadow: var(--shadow); transition: .25s ease;
        }
        button:hover { transform: translateY(-1px); box-shadow: 0 14px 40px rgba(0,0,0,.45) }
        button.active {
            background: #394073;
            border-color: #5d66a2;
        }
        
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 16px;
        }
        
        /* Əsas kart konteyneri */
        .card-container {
            position: relative;
            width: 100%;
            height: 340px; /* Bütün kartlar üçün sabit hündürlük */
            perspective: 1000px;
        }
        .card-container:hover { transform: translateY(-4px); box-shadow: 0 22px 60px rgba(0,0,0,.5) }
        
        /* Fırlanma effekti üçün daxili konteyner */
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }
        .card-container.is-flipped .card-inner {
            transform: rotateY(180deg);
        }
        
        /* Kartın iki tərəfi */
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            background: var(--card);
            border: 1px solid #2a2f57;
            padding: 14px;
            box-shadow: var(--shadow);
        }
        .card-back {
            transform: rotateY(180deg);
        }
        
        /* Tək tərəfli kartın əsas stilləri */
        .card-single {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 12px;
            background: var(--card);
            border: 1px solid #2a2f57;
            padding: 14px;
            box-shadow: var(--shadow);
            transition: transform .25s ease, box-shadow .25s ease;
        }
        .card-single:hover { transform: translateY(-4px); box-shadow: 0 22px 60px rgba(0,0,0,.5) }
        
        /* Fırlatma düyməsi */
        .flip-button {
            position: absolute;
            bottom: 14px;
            right: 14px;
            z-index: 10;
            background: rgba(43, 50, 100, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease-in-out;
        }
        .flip-button:hover {
            transform: scale(1.1);
        }
        .flip-button::before {
            content: '⇌';
            font-size: 20px;
            color: white;
            display: block;
            transform: scaleX(-1);
        }
        .card-container.is-flipped .flip-button::before {
            transform: scaleX(1);
        }
        
        /* Digər köhnə stillər */
        .card-front::after, .card-single::after {
            content: ""; position: absolute; inset: -2px; border-radius: 20px;
            pointer-events: none; border: 2px solid var(--ring); filter: blur(4px);
            opacity: .5; z-index: -1;
        }
        
        .head { display: flex; justify-content: space-between; margin-bottom: 10px }
        .name { font-weight: 700; letter-spacing: .3px }
        .badge { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid #ffffff2b }
        .card-tabs { display: flex; justify-content: center; margin-bottom: 8px; gap: 8px }
        .card-tabs button {
            background: #1e244a; color: #c9d3ff; border: 1px solid #2b3264;
            font-size: 11px; padding: 6px 12px; border-radius: 12px;
            cursor: pointer; transition: background .2s ease;
        }
        .card-tabs button.active { background: #2b3264; color: #fff }
        
        /* Bütün statistikalar bölmələri üçün ümumi stil */
        .stats-section {
            display: none;
            border-radius: 12px;
            padding: 8px;
            background: #111636;
            border: 1px solid #252c59;
        }
        
        /* Əsas və Əlavə statistikalar üçün grid düzülüşü */
        .stats-section[data-section-id="main-stats"].visible,
        .stats-section[data-section-id="additional-stats"].visible {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        /* Özəllik, Səviyyələr və Hekayə üçün blok düzülüşü (alt-alta) */
        .stats-section[data-section-id="trait"].visible,
        .stats-section[data-section-id="showlevels"].visible,
        .stats-section[data-section-id="story"].visible {
            display: block;
        }
        
        .stat-item { padding: 4px }
        .stat-item b { display: block; font-size: 12px; color: #c6ceff; margin-bottom: 4px }
        .stat-item span { font-size: 13px }
        .trait-center { text-align: center }
        
        /* color-mix istifadə edilən yerlərdə əvəzləmələr: */
        .r-mundane { box-shadow: 0 6px 28px rgba(204,204,204,0.35); }
        .r-familiar { box-shadow: 0 6px 28px rgba(76,175,80,0.35); }
        .r-arcane { box-shadow: 0 6px 28px rgba(126,87,194,0.35); }
        .r-mythic { box-shadow: 0 6px 28px rgba(229,57,53,0.35); }
        .r-legendary { box-shadow: 0 6px 28px rgba(251,192,45,0.35); }
        .r-ethereal { box-shadow: 0 6px 28px rgba(255,0,127,0.35); }
        
        /* Stripe (yuxarı rəng xətti) */
        .stripe {
            height: 6px;
            border-radius: 12px;
            margin: -14px -14px 10px;
            opacity: .9;
        }
        .r-mundane .stripe { background: var(--mundane) }
        .r-familiar .stripe { background: var(--familiar) }
        .r-arcane .stripe { background: var(--arcane) }
        .r-mythic .stripe { background: var(--mythic) }
        .r-legendary .stripe { background: var(--legendary) }
        .r-ethereal .stripe {
            background: linear-gradient(90deg, #ff9a9e, #fad0c4, #fad0c4, #ffd1ff, #ffecb3, #c3f5d5);
            background-size: 600% 100%;
            animation: ethereal-animate 10s linear infinite;
        }
        
        /* Kart adını rəngləndirən yeni stil */
        .r-mundane .name { color: var(--mundane) }
        .r-familiar .name { color: var(--familiar) }
        .r-arcane .name { color: var(--arcane) }
        .r-mythic .name { color: var(--mythic) }
        .r-legendary .name { color: var(--legendary) }
        
        /* Gradient teext effekti alınmayan brauzerlər üçün ehtiyat rəng */
        .r-ethereal .name {
            color: var(--ethereal);
            background: linear-gradient(90deg, #ff9a9e, #fad0c4, #fad0c4, #ffd1ff, #ffecb3, #c3f5d5);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 600% 100%;
            animation: ethereal-animate 10s linear infinite;
        }
        
        @keyframes ethereal-animate {
            0% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Halo və halqa effektləri */
        .card-front::after, .card-single::after {
        content: "";
        position: absolute;
        inset: -2px;
        border-radius: 20px;
        pointer-events: none;
        border: 2px solid var(--ring);
        filter: blur(4px);
        opacity: .5;
        z-index: -1;
        }
        
        /* Əsas menyu və geri düyməsi */
        .main-menu {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        text-align: center;
        }
        .main-menu h1 { font-size: 48px; margin-bottom: 24px; text-shadow: 0 0 15px rgba(255,255,255,.2) }
        .menu-buttons { display: flex; flex-direction: column; gap: 16px; width: 80%; max-width: 300px }
        
        .hidden { display: none !important }
        
        .card-title-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 18px;
        }
        .back-button {
        background: transparent;
        border: 1px solid var(--muted);
        color: var(--muted);
        font-size: 14px;
        padding: 8px 16px;
        border-radius: 8px;
        }
        
        /* Ethereal parıltısı üçün əlavə glow */
        .card-glow {
        position: absolute;
        inset: -8px;
        border-radius: 16px;
        pointer-events: none;
        background: radial-gradient(120px 80px at 80% 0%, rgba(255,0,127,.35), transparent 70%),
        radial-gradient(120px 80px at 0% 100%, rgba(255,220,120,.25), transparent 70%);
        filter: blur(8px);
        opacity: .9;
        z-index: -1;
        }
        
        .name .note {
            font-size: 0.75em;
            color: #CCCCCC;
            opacity: 0.7;
            margin-left: 3px;
        }

        .story-content {
            font-size: 13px;
            line-height: 1.5;
            text-align: left;
            margin-top: 10px;
            padding: 10px;
            background: #252c59;
            border-radius: 8px;
            border: 1px solid #3d4677;
        }

        .story-loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: var(--muted);
        }

        .story-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/a134a94991.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <div id="main-menu" class="main-menu">
            <h1>Kart Qalereyası</h1>
            <div class="menu-buttons">
                <button id="show-cards-btn">Kartları Göstər</button>
                <button id="show-stats">Statistikalar</button>
                <button id="show-spells-btn">Spellər</button>
                <button id="show-boosters-btn">Boosterlər</button>
                <button id="show-towers-btn">Towers</button>
            </div>
        </div>

        <div id="cards-section" class="cards-section hidden">
            <div class="controls">
                <button id="filter-all" class="active">Hamısı</button>
                <button id="filter-mundane">Mundane</button>
                <button id="filter-familiar">Familiar</button>
                <button id="filter-arcane">Arcane</button>
                <button id="filter-mythic">Mythic</button>
                <button id="filter-legendary">Legendary</button>
                <button id="filter-ethereal">Ethereal</button>
            </div>
            <div id="cards" class="cards-container grid"></div>
            <div style="text-align:center; margin-top:20px;">
                <button id="back-to-menu-btn">Menyuya Geri Qayıt</button>
            </div>
        </div>

        <div id="stats-section" class="stats-section hidden">
            <h1>Statistikalar</h1>
            <div class="stats-charts">
                <div class="chart-container">
                    <h2>Kart Tipləri</h2>
                    <canvas id="chart-types"></canvas>
                </div>
                <div class="chart-container">
                    <h2>Endərliklər</h2>
                    <canvas id="chart-rarities"></canvas>
                </div>
                <div class="chart-container">
                    <h2>Vəzifələr</h2>
                    <canvas id="chart-roles"></canvas>
                </div>
            </div>
            <div style="text-align:center; margin-top:20px;">
                <button id="back-to-menu-btn-stats">Menyuya Geri Qayıt</button>
            </div>
        </div>
    </div>

    <script>
        const mainMenu = document.getElementById('main-menu');
        const cardsSection = document.getElementById('cards-section');
        const showCardsBtn = document.getElementById('show-cards-btn');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const filterButtons = document.querySelectorAll('.controls button');
        const cardsContainer = document.getElementById('cards');
        const statsSection = document.getElementById('stats-section');
        const showStatsBtn = document.getElementById('show-stats');
        const backToMenuBtnStats = document.getElementById('back-to-menu-btn-stats');

        // LLM və TTS API funksiyaları üçün dəyişənlər
        const apiKey = "AIzaSyCr9A2i7Y-gwyfm44Po6ZKHpiMZ3JFzOx4"; 
        const generationApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

        let currentAudio = null;

        function showMenu() {
            mainMenu.classList.remove('hidden');
            cardsSection.classList.add('hidden');
            statsSection.classList.add('hidden');
        }

        function showCards() {
            mainMenu.classList.add('hidden');
            cardsSection.classList.remove('hidden');
            statsSection.classList.add('hidden');
            fetchAndRender('all');
        }

        function createCardElement(data) {
            const cardContainer = document.createElement('article');
            cardContainer.className = `card-container card r-${data.rarity.toLowerCase()}`;
            
            if (data.isMulti) {
                const cardInner = document.createElement('div');
                cardInner.className = 'card-inner';

                const cardFront = createCardContent(data);
                cardFront.classList.add('card-front');
                
                const cardBack = createCardContent(data.secondForm);
                cardBack.classList.add('card-back');

                cardInner.appendChild(cardFront);
                cardInner.appendChild(cardBack);
                cardContainer.appendChild(cardInner);

                const flipButton = document.createElement('button');
                flipButton.className = 'flip-button';

                cardContainer.addEventListener('click', (e) => {
                    if (e.target.closest('.flip-button')) {
                        cardContainer.classList.toggle('is-flipped');
                    }
                });

                cardContainer.appendChild(flipButton);
            } else {
                const singleCard = createCardContent(data);
                singleCard.classList.add('card-single');
                cardContainer.appendChild(singleCard);
            }

            if (data.rarity.toLowerCase() === 'ethereal') {
                const glowDiv = document.createElement('div');
                glowDiv.className = 'card-glow';
                glowDiv.setAttribute('aria-hidden', 'true');
                cardContainer.appendChild(glowDiv);
            }

            return cardContainer;
        }

        function createCardContent(data) {
            const content = document.createElement('div');
            const badgeText = data.isHybrid ? `${data.type[0]}/${data.type[1]}` : data.type[0];
            content.innerHTML = `
                <div class="stripe"></div>
                <div class="head">
                    <div class="name">
                        ${data.name}
                        ${data.note ? `<span class="note">${data.note}</span>` : ""}
                    </div>
                    <span class="badge">${badgeText}</span>
                </div>
                <div class="card-tabs">
                    <button class="active" data-section="main-stats">Əsas</button>
                    <button data-section="additional-stats">Əlavə</button>
                    <button data-section="trait">Özəllik</button>
                    <button data-section="showlevels">Səviyyə</button>
                    <button data-section="story" id="story-tab">Hekayə</button>
                </div>
                
                <div class="stats-section visible" data-section-id="main-stats">
                    <div class="stat-item"><b>Can <i class="fa-solid fa-heart"></i></b><span>${data.stats.health}</span></div>
                    <div class="stat-item"><b>Qalxan <i class="fa-solid fa-shield-halved"></i></b><span>${data.stats.shield}</span></div>
                    <div class="stat-item"><b>Hasar <i class="fa-solid fa-hand-fist"></i></b><span>${data.stats.damage}</span></div>
                    <div class="stat-item"><b>S.B.H <i class="fa-solid fa-bolt"></i></b><span>${data.stats.sps}</span></div>
                    <div class="stat-item"><b>Saldırı Hızı <i class="fa-solid fa-tachometer-alt"></i></b><span>${data.stats.attackSpeed}</span></div>
                    <div class="stat-item"><b>Gecikmə <i class="fa-solid fa-clock"></i></b><span>${data.stats.delay}</span></div>
                    <div class="stat-item"><b>Mana <i class="fa-solid fa-certificate"></i></b><span>${data.stats.mana}</span></div>
                    <div class="stat-item"><b>Say <i class="fa-solid fa-user"></i></b><span>${data.stats.number}</span></div>
                </div>
                
                <div class="stats-section" data-section-id="additional-stats">
                    <div class="stat-item"><b>Menzil <i class="fa-solid fa-road"></i></b><span>${data.additionalStats.range}</span></div>
                    <div class="stat-item"><b>Hız <i class="fa-solid fa-person-running"></i></b><span>${data.additionalStats.speed}</span></div>
                    <div class="stat-item"><b>Kritik Şansı <i class="fa-solid fa-percent"></i></b><span>${data.additionalStats.criticalChance}</span></div>
                    <div class="stat-item"><b>Kritik Hasar <i class="fa-solid fa-crosshairs"></i></b><span>${data.additionalStats.criticDamage}</span></div>
                    <div class="stat-item"><b>C.Çalma Şansı <i class="fa-solid fa-percent "></i></b><span>${data.additionalStats.lifestealChance}</span></div>
                    <div class="stat-item"><b>Can Çalma <i class="fa-solid fa-skull-crossbones "></i></b><span>${data.additionalStats.lifesteal}</span></div>
                    <div class="stat-item"><b>Hasar Azaltma <i class="fa-solid fa-helmet-un "></i></b><span>${data.additionalStats.damageminimiser}</span></div>
                    <div class="stat-item"><b>Sıyrılma Şansı <i class="fa-solid fa-wind "></i></b><span>${data.additionalStats.dodge}</span></div>
                </div>
                
                <div class="stats-section" data-section-id="trait">
                    <div class="trait trait-center">${data.trait}</div>
                </div>

                <div class="stats-section" data-section-id="showlevels">
                    <div class="stat-item"><b>Səviyyə 1</b><span>${data.showlevels.level1}</span></div>
                    <div class="stat-item"><b>Səviyyə 2</b><span>${data.showlevels.level2}</span></div>
                    <div class="stat-item"><b>Səviyyə 3</b><span>${data.showlevels.level3}</span></div>
                </div>
                
                <div class="stats-section" data-section-id="story">
                    <p class="story-content" id="story-text-${data.name.replace(/\s/g, '-')}-${badgeText.replace(/\//g, '-')}">Hekayəni yaratmaq üçün aşağıdakı düyməyə klikləyin.</p>
                    <div class="story-actions">
                        <button class="generate-story-btn" data-card-name="${data.name}" data-card-type="${badgeText}" data-card-rarity="${data.rarity}" data-card-stats='${JSON.stringify(data.stats)}' data-card-additional-stats='${JSON.stringify(data.additionalStats)}'>Hekayə Yarat ✨</button>
                        <button class="play-story-btn hidden"><i class="fas fa-play"></i> Dinlə</button>
                    </div>
                </div>
            `;

            const cardButtons = content.querySelectorAll('.card-tabs button');
            cardButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const sectionId = button.dataset.section;
                    
                    cardButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    content.querySelectorAll('.stats-section').forEach(section => {
                        section.classList.remove('visible');
                    });
                    content.querySelector(`[data-section-id="${sectionId}"]`).classList.add('visible');
                });
            });

            const generateButton = content.querySelector('.generate-story-btn');
            generateButton.addEventListener('click', () => generateStory(generateButton, data));
            
            const playButton = content.querySelector('.play-story-btn');
            playButton.addEventListener('click', () => playAudio(playButton, data));

            return content;
        }

        async function generateStory(button, data) {
            const storyTextElem = button.closest('[data-section-id="story"]').querySelector('.story-content');
            const playButton = button.closest('.story-actions').querySelector('.play-story-btn');
            
            const originalButtonText = button.innerHTML;
            button.innerHTML = 'Yaradılır...';
            button.disabled = true;
            storyTextElem.textContent = 'Hekayə yaradılır... Zəhmət olmasa gözləyin.';
            playButton.classList.add('hidden');

            const systemPrompt = "Sən dünya səviyyəli bir oyun hekayəçisisən. Kartın adı, növü və statistikalarına əsaslanaraq, onun hekayəsi, tarixi və oyun kainatındakı rolu haqqında maraqlı və yaradıcı bir mətn yarat.";
            const userQuery = `Aşağıdakı kart üçün hekayə yaz: Adı: ${data.name}, Növü: ${data.isHybrid ? data.type.join('/') : data.type[0]}, Endərlik: ${data.rarity}, Əsas Statistikalar: Can ${data.stats.health}, Qalxan ${data.stats.shield}, Hasar ${data.stats.damage}, Sürət ${data.additionalStats.speed}.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                const response = await fetch(generationApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP xətası! Status: ${response.status}`);
                }
                
                const result = await response.json();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (generatedText) {
                    storyTextElem.textContent = generatedText;
                    storyTextElem.dataset.generatedText = generatedText;
                    playButton.classList.remove('hidden');
                } else {
                    storyTextElem.textContent = 'Hekayə yaradılmadı. Zəhmət olmasa yenidən cəhd edin.';
                }
            } catch (error) {
                console.error('Gemini API xətası:', error);
                storyTextElem.textContent = 'Xəta: Hekayə yaradıla bilmədi.';
            } finally {
                button.innerHTML = originalButtonText;
                button.disabled = false;
            }
        }

        async function playAudio(button, data) {
            const storyTextElem = button.closest('[data-section-id="story"]').querySelector('.story-content');
            const generatedText = storyTextElem.dataset.generatedText;

            if (!generatedText) {
                storyTextElem.textContent = 'Əvvəlcə hekayə yaratmalısınız.';
                return;
            }

            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }

            const originalButtonContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Yüklənir...';
            button.disabled = true;

            const payload = {
                contents: [{
                    parts: [{ text: generatedText }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const response = await fetch(ttsApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;
                
                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    currentAudio = new Audio(audioUrl);
                    currentAudio.play();
                } else {
                    throw new Error("Səs faylı yaradıla bilmədi.");
                }
            } catch (error) {
                console.error('TTS API xətası:', error);
                storyTextElem.textContent = 'Xəta: Səsli oxunuş əlçatan deyil.';
            } finally {
                button.innerHTML = originalButtonContent;
                button.disabled = false;
            }
        }

        // Helper function to convert Base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Helper function to convert PCM audio data to WAV format
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.byteLength;
            
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            
            // RIFF chunk
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            
            // fmt chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM format
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true); // Bits per sample
            
            // data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);
            
            let pcmView = new Uint8Array(pcmData.buffer);
            for (let i = 0; i < dataSize; i++) {
                view.setUint8(44 + i, pcmView[i]);
            }
            
            return new Blob([view], { type: 'audio/wav' });
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function renderCards(cardsToRender) {
            cardsContainer.innerHTML = '';
            if (!Array.isArray(cardsToRender) || cardsToRender.length === 0) {
                cardsContainer.innerHTML = '<p>Bu endərlikdə kart tapılmadı.</p>';
                return;
            }
            cardsToRender.forEach(data => {
                cardsContainer.appendChild(createCardElement(data));
            });
        }

        async function fetchAndRender(rarity) {
            cardsContainer.innerHTML = '<p class="story-loading">Yüklənir...</p>';
            try {
                let cardsData = [];
                if (rarity === 'all') {
                    const rarities = ['mundane', 'familiar', 'arcane', 'mythic', 'legendary', 'ethereal'];
                    const fetchPromises = rarities.map(r =>
                        fetch(`${r}.json`).then(async res => {
                            if (!res.ok) {
                                if (res.status === 404) {
                                    console.warn(`${r}.json tapılmadı, bu endərlik ötürülür.`);
                                    return [];
                                }
                                throw new Error(`${r}.json yüklənmədi`);
                            }
                            const text = await res.text();
                            return text ? JSON.parse(text) : [];
                        })
                    );
                    const results = await Promise.all(fetchPromises);
                    cardsData = results.flat();
                } else {
                    const response = await fetch(`${rarity}.json`);
                    if (!response.ok) {
                        if (response.status === 404) {
                            console.warn(`${rarity}.json tapılmadı.`);
                            cardsData = [];
                        } else {
                            throw new Error(`HTTP xətası! Status: ${response.status}`);
                        }
                    } else {
                        const text = await response.text();
                        cardsData = text ? JSON.parse(text) : [];
                    }
                }
                renderCards(cardsData);
            } catch (error) {
                console.error('Məlumatları yükləmə zamanı xəta:', error);
                cardsContainer.innerHTML = '<p class="story-loading">Kart məlumatları yüklənərkən xəta baş verdi.</p>';
            }
        }

        showCardsBtn.addEventListener('click', showCards);
        backToMenuBtn.addEventListener('click', showMenu);
        backToMenuBtnStats.addEventListener('click', showMenu);

        ['show-spells-btn', 'show-boosters-btn', 'show-towers-btn'].forEach(id => {
            document.getElementById(id).addEventListener('click', () => {
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '50%';
                modal.style.left = '50%';
                modal.style.transform = 'translate(-50%, -50%)';
                modal.style.padding = '20px';
                modal.style.backgroundColor = 'var(--card)';
                modal.style.color = 'var(--text)';
                modal.style.borderRadius = '12px';
                modal.style.boxShadow = 'var(--shadow)';
                modal.style.zIndex = '1000';
                modal.textContent = "Bu bölmə hələ hazır deyil.";
                document.body.appendChild(modal);
                setTimeout(() => { document.body.removeChild(modal); }, 3000);
            });
        });

        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                const rarity = button.id.split('-')[1];
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                fetchAndRender(rarity);
            });
        });

        document.addEventListener('DOMContentLoaded', showMenu);

        showStatsBtn.addEventListener('click', () => {
            mainMenu.classList.add('hidden');
            cardsSection.classList.add('hidden');
            statsSection.classList.remove('hidden');
            renderCharts();
        });

        function renderCharts() {
            new Chart(document.getElementById('chart-types'), {
                type: 'pie',
                data: {
                    labels: ['Heyvan', 'Robot', 'İnsan'],
                    datasets: [{
                        data: [5, 3, 7],
                        backgroundColor: ['#ff9999', '#66b3ff', '#99ff99']
                    }]
                }
            });

            new Chart(document.getElementById('chart-rarities'), {
                type: 'bar',
                data: {
                    labels: ['Mundane', 'Familiar', 'Arcane', 'Mythic', 'Legendary', 'Ethereal'],
                    datasets: [{
                        label: 'Kart Sayı',
                        data: [10, 8, 12, 6, 4, 2],
                        backgroundColor: '#8a92b2'
                    }]
                }
            });

            new Chart(document.getElementById('chart-roles'), {
                type: 'doughnut',
                data: {
                    labels: ['Hücum', 'Müdafiə', 'Dəstək'],
                    datasets: [{
                        data: [7, 5, 6],
                        backgroundColor: ['#ffcc99', '#c2c2f0', '#ffb3e6']
                    }]
                }
            });
        }
    </script>
</body>
</html>
